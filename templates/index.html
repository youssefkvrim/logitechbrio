<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Logitech BRIO Capture</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 640px; margin: 40px auto; padding: 0 16px; }
      h2 { margin: 0 0 16px; }
      label { display: block; margin-bottom: 8px; }
      input, select { width: 100%; padding: 12px; font-size: 16px; box-sizing: border-box; }
      button { padding: 10px 16px; font-size: 16px; margin-top: 12px; }
      .status { margin-top: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .block { margin-top: 12px; }
      .video { width: 100%; background: #000; aspect-ratio: 16/9; object-fit: cover; }
      #clock { position: fixed; top: 8px; right: 12px; font-size: 14px; color: #333; }
    </style>
  </head>
  <body>
    <div id="clock"></div>
    <h2>Logitech BRIO Capture</h2>

    <div class="block" style="position:relative;">
      <img id="video" class="video" src="/stream" alt="Live" />
      <button id="gearBtn" type="button" style="position:absolute; top:8px; right:8px;">⚙️</button>
    </div>

    <div id="settingsPanel" class="block" style="display:none; border:1px solid #ddd; padding:12px; border-radius:8px;">
      <div class="row">
        <div>
          <label for="cameraIndex">Camera</label>
          <div class="row" style="grid-template-columns: 1fr auto; gap: 8px;">
            <select id="cameraIndex"></select>
            <button id="rescanBtn" type="button">Rescan</button>
          </div>
        </div>
        <div>
          <label for="saveDir">Save directory</label>
          <div class="row" style="grid-template-columns: 1fr auto; gap: 8px;">
            <input id="saveDir" type="text" placeholder="Path to save images" />
            <button id="browseBtn" type="button">Browse…</button>
          </div>
        </div>
      </div>
      <div class="block">
        <label>Camera settings</label>
        <div class="row" style="grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <div>Brightness <span id="val_brightness"></span></div>
            <input id="brightness" type="range" min="0" max="255" step="1" />
          </div>
          <div>
            <div>Contrast <span id="val_contrast"></span></div>
            <input id="contrast" type="range" min="0" max="255" step="1" />
          </div>
          <div>
            <div>Saturation <span id="val_saturation"></span></div>
            <input id="saturation" type="range" min="0" max="255" step="1" />
          </div>
          <div>
            <div>Sharpness <span id="val_sharpness"></span></div>
            <input id="sharpness" type="range" min="0" max="255" step="1" />
          </div>
          <div>
            <div>Zoom <span id="val_zoom"></span></div>
            <input id="zoom" type="range" min="1" max="500" step="1" />
          </div>
        </div>
      </div>
    </div>

    <div class="row block">
      <div>
        <label for="presetName">Select name</label>
        <select id="presetName">
          <option value="">Custom…</option>
          <option>M7-3_005</option>
          <option>M7-3_006</option>
          <option>M7-3_025ITK</option>
          <option>M7-3_1-2ITG</option>
          <option>M7-3_1-2PFX</option>
          <option>2CN2_005</option>
          <option>2CN2_007</option>
          <option>2CN2_008</option>
          <option>2CN2_ITK57U</option>
          <option>R55_010</option>
          <option>R55_011</option>
          <option>R55_012ITG</option>
          <option>R55_ITK57U</option>
        </select>
      </div>
      <div>
        <label for="baseName">Custom name (optional)</label>
        <input id="baseName" type="text" placeholder="e.g., M7-3_006" />
      </div>
    </div>

    <div class="block">
      <button id="captureBtn">Capture</button>
    </div>

    <div class="status" id="status"></div>

    <script>
      const input = document.getElementById('baseName');
      const preset = document.getElementById('presetName');
      const statusEl = document.getElementById('status');
      const btn = document.getElementById('captureBtn');
      const cameraSelect = document.getElementById('cameraIndex');
      const saveDir = document.getElementById('saveDir');
      const browseBtn = document.getElementById('browseBtn');
      const gearBtn = document.getElementById('gearBtn');
      const settingsPanel = document.getElementById('settingsPanel');
      const rescanBtn = document.getElementById('rescanBtn');
      const clockEl = document.getElementById('clock');

      function pad2(n) { return n.toString().padStart(2, '0'); }
      function monthAbbr(i) {
        return ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'][i] || '';
      }
      function renderClock() {
        const d = new Date();
        const dd = pad2(d.getDate());
        const mmm = monthAbbr(d.getMonth());
        const yyyy = d.getFullYear();
        const hh = pad2(d.getHours());
        const mm = pad2(d.getMinutes());
        const ss = pad2(d.getSeconds());
        clockEl.textContent = `${dd} ${mmm} ${yyyy}  ${hh}:${mm}:${ss}`;
      }
      setInterval(renderClock, 500);
      renderClock();

      function chosenName() {
        return (preset.value || input.value || '').trim();
      }

      async function loadConfig() {
        try {
          const res = await fetch('/config');
          const data = await res.json();
          if (!data.ok) return;
          cameraSelect.innerHTML = '';
          for (const idx of data.available_indices) {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = 'Camera #' + idx + (idx === data.camera_index ? ' (current)' : '');
            if (idx === data.camera_index) opt.selected = true;
            cameraSelect.appendChild(opt);
          }
          saveDir.value = data.save_dir || '';
          await loadProps();
        } catch {}
      }

      async function loadProps() {
        try {
          const res = await fetch('/camera_props');
          const data = await res.json();
          if (!data.ok) return;
          const p = data.props || {};
          for (const key of ['brightness','contrast','saturation','sharpness','zoom']) {
            if (p[key] != null && document.getElementById(key)) {
              const el = document.getElementById(key);
              el.value = p[key];
              const valEl = document.getElementById('val_' + key);
              if (valEl) valEl.textContent = p[key];
            }
          }
        } catch {}
      }

      async function capture() {
        const base = chosenName();
        statusEl.textContent = 'Capturing...';
        try {
          const res = await fetch('/capture', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_base_name: base, save_dir: saveDir.value || undefined })
          });
          const data = await res.json();
          if (data.ok) {
            statusEl.textContent = 'Saved: ' + data.saved_path;
            if (!preset.value) input.select();
          } else {
            statusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
          }
        } catch (err) {
          statusEl.textContent = 'Request failed';
        }
      }

      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); capture(); } });
      btn.addEventListener('click', capture);

      async function applySettings() {
        statusEl.textContent = 'Applying settings...';
        try {
          const res = await fetch('/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ camera_mode: 'index', camera_index: parseInt(cameraSelect.value, 10), save_dir: saveDir.value || undefined })
          });
          const data = await res.json();
          if (data.ok) {
            statusEl.textContent = 'Settings applied.';
            loadConfig();
            const v = document.getElementById('video');
            v.src = '/stream?ts=' + Date.now();
          } else {
            statusEl.textContent = 'Failed to apply: ' + (data.errors || []).join(', ');
          }
        } catch (e) {
          statusEl.textContent = 'Apply failed';
        }
      }

      preset.addEventListener('change', () => {
        if (preset.value) input.value = '';
      });

      async function chooseDir() {
        statusEl.textContent = 'Opening folder chooser...';
        try {
          const res = await fetch('/choose_dir', { method: 'POST' });
          const data = await res.json();
          if (data.ok && data.selected) {
            saveDir.value = data.selected;
            statusEl.textContent = 'Folder selected.';
            applySettings();
          } else {
            statusEl.textContent = data.error ? ('Folder chooser: ' + data.error) : 'No folder selected';
          }
        } catch (e) {
          statusEl.textContent = 'Folder chooser failed';
        }
      }

      browseBtn.addEventListener('click', chooseDir);
      saveDir.addEventListener('click', chooseDir);
      saveDir.addEventListener('change', applySettings);
      cameraSelect.addEventListener('change', applySettings);

      rescanBtn.addEventListener('click', async () => {
        statusEl.textContent = 'Rescanning cameras...';
        try {
          const res = await fetch('/rescan_cameras', { method: 'POST' });
          const data = await res.json();
          if (data.ok) {
            statusEl.textContent = 'Cameras updated.';
            loadConfig();
          } else {
            statusEl.textContent = 'Rescan failed';
          }
        } catch {
          statusEl.textContent = 'Rescan error';
        }
      });

      function toggleSettings() {
        const visible = settingsPanel.style.display !== 'none';
        settingsPanel.style.display = visible ? 'none' : 'block';
      }
      gearBtn.addEventListener('click', toggleSettings);

      for (const key of ['brightness','contrast','saturation','sharpness','zoom']) {
        const el = document.getElementById(key);
        if (!el) continue;
        el.addEventListener('input', async () => {
          const body = {}; body[key] = parseFloat(el.value);
          const valEl = document.getElementById('val_' + key);
          if (valEl) valEl.textContent = el.value;
          try {
            await fetch('/camera_props', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          } catch {}
        });
      }

      loadConfig();
    </script>
  </body>
</html>


